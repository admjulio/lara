<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Unimed – Lara & Alice</title>
  <style>
    :root {
      --unimed-green: #008542;
      --unimed-green-dark: #006b34;
      --bg: #f6f7f9;
      --text: #111;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: var(--bg);
      text-align: center;
    }
    header {
      background: var(--unimed-green);
      padding: 16px 20px;
    }
    header img { max-height: 56px; }
    main {
      padding: 36px 20px 80px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p  { margin: 0 0 24px; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 6px;
      background: var(--unimed-green);
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      border: 0;
      transition: filter .2s ease, background .2s ease;
      user-select: none;
    }
    .btn:hover { background: var(--unimed-green-dark); }
    #div_chatbot {
      position: fixed;
      z-index: 100000;
      bottom: 15px;
      right: 15px;
    }
    #div_chatbot img {
      width: 180px;
      height: 180px;
      cursor: pointer;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,.2));
      transition: transform .15s ease;
    }
    #div_chatbot img:hover { transform: scale(1.03); }
    footer {
      margin: 40px 0 20px;
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>

  <header>
    <img src="https://www.unimed.coop.br/site/image/layout_set_logo?img_id=1300085" alt="Unimed" />
  </header>

  <main>
    <h1>Atendimento Digital</h1>
    <p>Clique para abrir o chat em <b>pop-up</b> (UC2B), já com o fluxo configurado.</p>

    <p>
      <a class="btn" href="javascript:void(0);" id="btn-alice">Abrir chat da Alice</a>
    </p>
  </main>

  <!-- Lara fixa no canto (abre em pop-up) -->
  <div id="div_chatbot">
    <a href="javascript:void(0);" id="btn-lara" aria-label="Abrir chat da Lara em pop-up">
      <img
        src="https://www.unimed.coop.br/site/documents/4195185/0/lara.png/28fd2d03-20d4-cba3-0117-f8d2f6446082?t=1649783866815"
        alt="Lara - Assistente virtual"
      />
    </a>
  </div>

  <footer>
    <span>© Unimed • Ambiente de testes do chat UC2B</span>
  </footer>

  <script>
    /**
     * Abre uma janela pop-up (500x800) centralizada e injeta o UC2BChat com o flow informado.
     * Força widgets injetados (ex.: rocketchat-widget) a iniciar com data-state="closed".
     */
    function openChatInPopupWithUC2B(flowId) {
      var width  = 400;
      var height = 700;

      // Centralização simples
      var screenW = (window.screen && window.screen.width)  ? window.screen.width  : 1024;
      var screenH = (window.screen && window.screen.height) ? window.screen.height : 768;
      var left = Math.max(0, Math.round((screenW - width) / 2));
      var top  = Math.max(0, Math.round((screenH - height) / 2));

      var features = [
        'width=' + width,
        'height=' + height,
        'left=' + left,
        'top=' + top,
        'resizable=yes',
        'scrollbars=yes'
      ].join(',');

      var w = window.open('about:blank', 'chat_window_uc2b', features);

      if (!w) {
        alert('Seu navegador bloqueou o pop-up. Permita pop-ups para este site.');
        return;
      }

      // HTML injetado no pop-up (sem h2 "Carregando atendimento…")
      var html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chat Unimed</title>
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: grid;
      place-items: center;
      background: #ffffff;
      color: #111;
    }
    .container {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
    }
  </style>
</head>
<body>
  <div class="container" aria-live="polite" aria-busy="true"></div>

  <!-- Loader oficial UC2BChat -->
  <script>
    (function(w, d, s, u) {
      w.UC2BChat = function(c) { w.UC2BChat._.push(c) };
      w.UC2BChat._ = [];
      w.UC2BChat.url = u;
      var h = d.getElementsByTagName(s)[0], j = d.createElement(s);
      j.async = true;
      j.src = "https://unimedomni.cloudcanal.com.br/livechat/livechat.min.js";
      h.parentNode.insertBefore(j, h);
    })(window, document, 'script', "https://unimedomni.cloudcanal.com.br/livechat");
  <\/script>

  <script>
    // Força qualquer widget injetado a iniciar fechado (data-state="closed")
    (function forceWidgetClosed(){
      function setClosed(el){
        try { el.setAttribute('data-state', 'closed'); } catch(e) {}
      }
      // Varredura inicial
      document.querySelectorAll('.rocketchat-widget,[data-state]').forEach(setClosed);
      // Observa novas inserções de nós e ajusta
      var obs = new MutationObserver(function(muts){
        muts.forEach(function(m){
          m.addedNodes.forEach(function(n){
            if (n && n.nodeType === 1) {
              if (n.matches && (n.matches('.rocketchat-widget') || n.hasAttribute('data-state'))) {
                setClosed(n);
              }
              if (n.querySelectorAll) {
                n.querySelectorAll('.rocketchat-widget,[data-state]').forEach(setClosed);
              }
            }
          });
        });
      });
      obs.observe(document.documentElement, { childList: true, subtree: true });
    })();

    // Configura apenas o flow; não abrimos o chat automaticamente
    (function initChat(flowId){
      function waitAndSet() {
        if (!window.UC2BChat || typeof window.UC2BChat !== 'function') {
          return setTimeout(waitAndSet, 200);
        }
        UC2BChat(function () {
          try {
            if (typeof this.setLinkedToFlow === 'function') {
              this.setLinkedToFlow(flowId);
              console.log('Flow configurado:', flowId);
            } else {
              console.warn('setLinkedToFlow não disponível na instância UC2BChat.');
            }
            // NÃO chamar openChat/toggle/show: manter fechado por padrão
          } catch(e) {
            console.error('Erro ao configurar o flow:', e);
          }
        });
      }
      waitAndSet();
    })('${flowId}');
  <\/script>
</body>
</html>
      `;

      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    // Ligações dos botões
    (function bindUI() {
      var btnAlice = document.getElementById('btn-alice');
      var btnLara  = document.getElementById('btn-lara');

      if (btnAlice) {
        btnAlice.addEventListener('click', function (e) {
          e.preventDefault();
          openChatInPopupWithUC2B('68a46e661790425f4016a228'); // Alice
        });
      }
      if (btnLara) {
        btnLara.addEventListener('click', function (e) {
          e.preventDefault();
          openChatInPopupWithUC2B('673f883adc527a52ff1ae5c9'); // Lara
        });
      }
    })();
  </script>
</body>
</html>
