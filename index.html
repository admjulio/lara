<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Unimed – Lara & Alice</title>
  <style>
    :root {
      --unimed-green: #008542;
      --unimed-green-dark: #006b34;
      --bg: #f6f7f9;
      --text: #111;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background: var(--bg);
      text-align: center;
    }
    header {
      background: var(--unimed-green);
      padding: 16px 20px;
    }
    header img { max-height: 56px; }
    main {
      padding: 36px 20px 80px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p  { margin: 0 0 24px; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 6px;
      background: var(--unimed-green);
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
      border: 0;
      transition: filter .2s ease, background .2s ease;
      user-select: none;
    }
    .btn:hover { background: var(--unimed-green-dark); }
    #div_chatbot {
      position: fixed;
      z-index: 100000;
      bottom: 15px;
      right: 15px;
    }
    #div_chatbot img {
      width: 180px;
      height: 180px;
      cursor: pointer;
      filter: drop-shadow(0 8px 20px rgba(0,0,0,.2));
      transition: transform .15s ease;
    }
    #div_chatbot img:hover { transform: scale(1.03); }
    footer {
      margin: 40px 0 20px;
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>

  <header>
    <img src="https://www.unimed.coop.br/site/image/layout_set_logo?img_id=1300085" alt="Unimed" />
  </header>

  <main>
    <h1>Atendimento Digital</h1>
    <p>Clique para abrir o chat em uma <b>nova aba</b> usando o widget UC2B.</p>

    <p>
      <a class="btn" href="javascript:void(0);" id="btn-alice">Abrir chat da Alice</a>
    </p>
  </main>

  <!-- Lara fixa no canto que abre em nova aba -->
  <div id="div_chatbot">
    <a href="javascript:void(0);" id="btn-lara" aria-label="Abrir chat da Lara em nova aba">
      <img
        src="https://www.unimed.coop.br/site/documents/4195185/0/lara.png/28fd2d03-20d4-cba3-0117-f8d2f6446082?t=1649783866815"
        alt="Lara - Assistente virtual"
      />
    </a>
  </div>

  <footer>
    <span>© Unimed • Ambiente de testes do chat UC2B</span>
  </footer>

  <script>
    /**
     * Abre uma NOVA ABA (about:blank), injeta o UC2BChat e seta o flow informado.
     * Mantém fallback para tentar abrir o widget se não houver API explícita.
     */
    function openChatInNewTabWithUC2B(flowId) {
      // Abre a nova aba no clique do usuário (evita bloqueio de pop-up)
      var w = window.open('about:blank', '_blank');
      if (!w) {
        alert('Seu navegador bloqueou a nova aba. Permita pop-ups para este site.');
        return;
      }

      // HTML que será injetado na nova aba
      var html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Chat Unimed</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; }
    .status { font-size:14px; color:#444; }
  </style>
</head>
<body>
  <h2>Carregando atendimento…</h2>
  <p class="status">Aguarde um instante enquanto iniciamos o chat.</p>

  <!-- Loader oficial UC2BChat -->
  <script>
    (function(w, d, s, u) {
      w.UC2BChat = function(c) { w.UC2BChat._.push(c) };
      w.UC2BChat._ = [];
      w.UC2BChat.url = u;
      var h = d.getElementsByTagName(s)[0], j = d.createElement(s);
      j.async = true;
      j.src = "https://unimedomni.cloudcanal.com.br/livechat/livechat.min.js?_=201903270000";
      h.parentNode.insertBefore(j, h);
    })(window, document, 'script', "https://unimedomni.cloudcanal.com.br/livechat");
  <\/script>

  <script>
    // Tenta configurar o flow e abrir o widget com vários métodos.
    (function initChat(flowId){
      function tryOpen() {
        if (!window.UC2BChat || typeof window.UC2BChat !== 'function') {
          return setTimeout(tryOpen, 200);
        }
        UC2BChat(function () {
          try {
            if (typeof this.setLinkedToFlow === 'function') {
              this.setLinkedToFlow(flowId);
              console.log('Flow setado:', flowId);
            } else {
              console.warn('setLinkedToFlow não disponível.');
            }

            if (typeof this.openChat === 'function') {
              this.openChat();  // alguns widgets expõem isso
              console.log('openChat() chamado');
              return;
            }
            if (typeof this.toggle === 'function') {
              this.toggle(true); // abre se estiver fechado
              console.log('toggle(true) chamado');
              return;
            }
            if (typeof this.show === 'function') {
              this.show();
              console.log('show() chamado');
              return;
            }
            if (typeof this.setOpened === 'function') {
              this.setOpened(true);
              console.log('setOpened(true) chamado');
              return;
            }

            // Fallback robusto: tenta achar/acionar um launcher por alguns segundos
            setTimeout(function () {
              var tries = 0;
              var interval = setInterval(function () {
                tries++;
                var selectors = [
                  '.uc2b-launcher',
                  '[data-uc2bchat-launcher]',
                  '#uc2b-launcher',
                  '.livechat-launcher',
                  '[aria-label="Abrir chat"]',
                  'button[title*="Chat"]',
                  'button[aria-label*="Chat"]'
                ];
                var btn = null, used = null;
                for (var i = 0; i < selectors.length; i++) {
                  btn = document.querySelector(selectors[i]);
                  if (btn) { used = selectors[i]; break; }
                }
                if (btn) {
                  btn.click();
                  console.log('Fallback: clique no launcher via', used);
                  clearInterval(interval);
                }
                if (tries > 20) {
                  clearInterval(interval);
                  console.warn('Fallback: launcher não encontrado após várias tentativas.');
                }
              }, 200);
            }, 200);

          } catch (e) {
            console.error('Erro ao abrir o chat:', e);
          }
        });
      }
      tryOpen();
    })('${flowId}');
  <\/script>
</body>
</html>
      `;

      // injeta o HTML na nova aba
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    // Ligações dos botões
    (function bindUI() {
      var btnAlice = document.getElementById('btn-alice');
      var btnLara  = document.getElementById('btn-lara');

      if (btnAlice) {
        btnAlice.addEventListener('click', function (e) {
          e.preventDefault();
          openChatInNewTabWithUC2B('68a46e661790425f4016a228'); // Alice
        });
      }
      if (btnLara) {
        btnLara.addEventListener('click', function (e) {
          e.preventDefault();
          openChatInNewTabWithUC2B('673f883adc527a52ff1ae5c9'); // Lara
        });
      }
    })();
  </script>
</body>
</html>
